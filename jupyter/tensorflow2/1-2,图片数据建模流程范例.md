# 1-2,å›¾ç‰‡æ•°æ®å»ºæ¨¡æµç¨‹èŒƒä¾‹


### ä¸€ï¼Œå‡†å¤‡æ•°æ®


cifar2æ•°æ®é›†ä¸ºcifar10æ•°æ®é›†çš„å­é›†ï¼ŒåªåŒ…æ‹¬å‰ä¸¤ç§ç±»åˆ«airplaneå’Œautomobileã€‚

è®­ç»ƒé›†æœ‰airplaneå’Œautomobileå›¾ç‰‡å„5000å¼ ï¼Œæµ‹è¯•é›†æœ‰airplaneå’Œautomobileå›¾ç‰‡å„1000å¼ ã€‚

cifar2ä»»åŠ¡çš„ç›®æ ‡æ˜¯è®­ç»ƒä¸€ä¸ªæ¨¡å‹æ¥å¯¹é£æœºairplaneå’ŒæœºåŠ¨è½¦automobileä¸¤ç§å›¾ç‰‡è¿›è¡Œåˆ†ç±»ã€‚

æˆ‘ä»¬å‡†å¤‡çš„Cifar2æ•°æ®é›†çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚

![](./data/cifar2.jpg)

```python

```

åœ¨tensorflowä¸­å‡†å¤‡å›¾ç‰‡æ•°æ®çš„å¸¸ç”¨æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯ä½¿ç”¨tf.kerasä¸­çš„ImageDataGeneratorå·¥å…·æ„å»ºå›¾ç‰‡æ•°æ®ç”Ÿæˆå™¨ã€‚

ç¬¬äºŒç§æ˜¯ä½¿ç”¨tf.data.Datasetæ­é…tf.imageä¸­çš„ä¸€äº›å›¾ç‰‡å¤„ç†æ–¹æ³•æ„å»ºæ•°æ®ç®¡é“ã€‚

ç¬¬ä¸€ç§æ–¹æ³•æ›´ä¸ºç®€å•ï¼Œå…¶ä½¿ç”¨èŒƒä¾‹å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ã€‚

[ã€ŠKeraså›¾åƒæ•°æ®é¢„å¤„ç†èŒƒä¾‹â€”â€”Cifar2å›¾ç‰‡åˆ†ç±»ã€‹](https://mp.weixin.qq.com/s?__biz=MzU3OTQzNTU2OA==&mid=2247484795&idx=1&sn=16947726702b87ee535aef0d6ae2db30&chksm=fd676824ca10e1321e77c5fa44339c0a79442cd8d7fbcc58697be166a4b0f990306848724692&mpshare=1&scene=1&srcid=1227ARPw2Ir8nVC4B84CjcIx&sharer_sharetime=1609043128020&sharer_shareid=808295d573831eb57288f1fc0ad3ac69&key=a58ea5adca8c8f06e4a7b7a15ed218f88cbee52ab3ee0fca3f2dd3f0797a36a6de26f8e75bd4787ddf97195c3959d94fe5060be0d3f9f6cd1eba11c0ad1ee37709088084d70034bd03efd43dacc32acd45a231c8359dd84ad73c28b11a9dc50556486b6e1e1ab89ad11da9621e5cdd858fcb53d91037d5116d638d12fced85b3&ascene=0&uin=MTYzMDEzMjAxMg%3D%3D&devicetype=iMac+MacBookAir7%2C2+OSX+OSX+10.14.6+build(18G6032)&version=11020113&lang=zh_CN&exportkey=A8nc9Ve3hcMzsggW3DOY8mU%3D&pass_ticket=JOjUjT6HXslkPfqXrPY1oG3qVEXbIIc1IAKdh8xjlrGyB8OtZ8JjRan45%2Ff%2Bknjb&wx_header=0)

ç¬¬äºŒç§æ–¹æ³•æ˜¯TensorFlowçš„åŸç”Ÿæ–¹æ³•ï¼Œæ›´åŠ çµæ´»ï¼Œä½¿ç”¨å¾—å½“çš„è¯ä¹Ÿå¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚

æˆ‘ä»¬æ­¤å¤„ä»‹ç»ç¬¬äºŒç§æ–¹æ³•ã€‚


```python
import tensorflow as tf 
from tensorflow.keras import datasets,layers,models

BATCH_SIZE = 100

def load_image(img_path,size = (32,32)):
    label = tf.constant(1,tf.int8) if tf.strings.regex_full_match(img_path,".*automobile.*") \
            else tf.constant(0,tf.int8)
    img = tf.io.read_file(img_path)
    img = tf.image.decode_jpeg(img) #æ³¨æ„æ­¤å¤„ä¸ºjpegæ ¼å¼
    img = tf.image.resize(img,size)/255.0
    return(img,label)

```

```python
#ä½¿ç”¨å¹¶è¡ŒåŒ–é¢„å¤„ç†num_parallel_calls å’Œé¢„å­˜æ•°æ®prefetchæ¥æå‡æ€§èƒ½
ds_train = tf.data.Dataset.list_files("./data/cifar2/train/*/*.jpg") \
           .map(load_image, num_parallel_calls=tf.data.experimental.AUTOTUNE) \
           .shuffle(buffer_size = 1000).batch(BATCH_SIZE) \
           .prefetch(tf.data.experimental.AUTOTUNE)  

ds_test = tf.data.Dataset.list_files("./data/cifar2/test/*/*.jpg") \
           .map(load_image, num_parallel_calls=tf.data.experimental.AUTOTUNE) \
           .batch(BATCH_SIZE) \
           .prefetch(tf.data.experimental.AUTOTUNE)  
dir(ds_train)
for i,v in enumerate(ds_train):
    print(type(v), v[1])
    break

```

```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

#æŸ¥çœ‹éƒ¨åˆ†æ ·æœ¬
from matplotlib import pyplot as plt 

plt.figure(figsize=(8,8)) 
for i,(img,label) in enumerate(ds_train.unbatch().take(9)):
    ax=plt.subplot(3,3,i+1)
    ax.imshow(img.numpy())
    ax.set_title("label = %d"%label)
    ax.set_xticks([])
    ax.set_yticks([]) 
plt.show()

```

![](./data/1-2-å›¾ç‰‡é¢„è§ˆ.jpg)

```python
for x,y in ds_train.take(1):
    print(x.shape,y.shape)
```

```
(100, 32, 32, 3) (100,)
```

```python
# tf.data.Dataset æ–¹æ³•è¯•éªŒ
import matplotlib.pyplot as plt

a = tf.data.Dataset.list_files("./data/cifar2/train/*/*.jpg")  # é»˜è®¤éšæœºè¯»å–
j= 0
for i in a:
    if j==3:break
    j += 1
    print(i)
    img = tf.io.read_file(i)
    img= tf.image.decode_jpeg(img)
    print(img.shape)
    plt.imshow(img)
    plt.show()

    print(f'-'*40)
    new_shape1 = 100
    new_shape2 = 100
    img1 = tf.image.resize(img,[new_shape1, new_shape1])/255.0
    img2 = tf.image.resize_with_pad(img,new_shape2,new_shape2)/255.0
    print(img1.shape)
    print(img2.shape)

    plt.subplot(1,2,1)
    plt.title('resize')   
    plt.imshow(img1)

    plt.subplot(1,2,2)
    plt.title('resize_with_pad') 
    plt.imshow(img2)
    plt.show()
    
# def load_image(img_path,size = (32,32)):
#     label = tf.constant(1,tf.int8) if tf.strings.regex_full_match(img_path,".*automobile.*") \
#             else tf.constant(0,tf.int8)
#     img = tf.io.read_file(img_path)
#     img = tf.image.decode_jpeg(img) #æ³¨æ„æ­¤å¤„ä¸ºjpegæ ¼å¼
#     img = tf.image.resize(img,size)/255.0
#     return(img,label)
```

### äºŒï¼Œå®šä¹‰æ¨¡å‹


ä½¿ç”¨Kerasæ¥å£æœ‰ä»¥ä¸‹3ç§æ–¹å¼æ„å»ºæ¨¡å‹ï¼šä½¿ç”¨SequentialæŒ‰å±‚é¡ºåºæ„å»ºæ¨¡å‹ï¼Œä½¿ç”¨å‡½æ•°å¼APIæ„å»ºä»»æ„ç»“æ„æ¨¡å‹ï¼Œç»§æ‰¿ModelåŸºç±»æ„å»ºè‡ªå®šä¹‰æ¨¡å‹ã€‚

æ­¤å¤„é€‰æ‹©ä½¿ç”¨å‡½æ•°å¼APIæ„å»ºæ¨¡å‹ã€‚

```python
tf.keras.backend.clear_session() #æ¸…ç©ºä¼šè¯

inputs = layers.Input(shape=(32,32,3))
x = layers.Conv2D(32,kernel_size=(3,3))(inputs)
x = layers.MaxPool2D()(x)  # é»˜è®¤pool_size=(2, 2),
x = layers.Conv2D(64,kernel_size=(5,5))(x)
x = layers.MaxPool2D()(x)
x = layers.Dropout(rate=0.1)(x)
x = layers.Flatten()(x)
x = layers.Dense(32,activation='relu')(x)
outputs = layers.Dense(1,activation = 'sigmoid')(x)

model = models.Model(inputs = inputs,outputs = outputs)

model.summary()
```

```
Model: "model"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv2d (Conv2D)              (None, 30, 30, 32)        896       
_________________________________________________________________
max_pooling2d (MaxPooling2D) (None, 15, 15, 32)        0         
_________________________________________________________________
conv2d_1 (Conv2D)            (None, 11, 11, 64)        51264     
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 5, 5, 64)          0         
_________________________________________________________________
dropout (Dropout)            (None, 5, 5, 64)          0         
_________________________________________________________________
flatten (Flatten)            (None, 1600)              0         
_________________________________________________________________
dense (Dense)                (None, 32)                51232     
_________________________________________________________________
dense_1 (Dense)              (None, 1)                 33        
=================================================================
Total params: 103,425
Trainable params: 103,425
Non-trainable params: 0
_________________________________________________________________
```

```python

```

### ä¸‰ï¼Œè®­ç»ƒæ¨¡å‹


è®­ç»ƒæ¨¡å‹é€šå¸¸æœ‰3ç§æ–¹æ³•ï¼Œå†…ç½®fitæ–¹æ³•ï¼Œå†…ç½®train_on_batchæ–¹æ³•ï¼Œä»¥åŠè‡ªå®šä¹‰è®­ç»ƒå¾ªç¯ã€‚æ­¤å¤„æˆ‘ä»¬é€‰æ‹©æœ€å¸¸ç”¨ä¹Ÿæœ€ç®€å•çš„å†…ç½®fitæ–¹æ³•ã€‚

```python
import datetime
import os

stamp = datetime.datetime.now().strftime("%Y%m%d-%H%M%S")
logdir = os.path.join('data', 'autograph', stamp)
print(logdir)
## åœ¨ Python3 ä¸‹å»ºè®®ä½¿ç”¨ pathlib ä¿®æ­£å„æ“ä½œç³»ç»Ÿçš„è·¯å¾„
# from pathlib import Path
# stamp = datetime.datetime.now().strftime("%Y%m%d-%H%M%S")
# logdir = str(Path('./data/autograph/' + stamp))

tensorboard_callback = tf.keras.callbacks.TensorBoard(logdir, histogram_freq=1)

model.compile(
        optimizer=tf.keras.optimizers.Adam(learning_rate=0.001),
        loss=tf.keras.losses.binary_crossentropy,
        metrics=["accuracy"]
    )

history = model.fit(ds_train,epochs= 10,validation_data=ds_test,
                    callbacks = [tensorboard_callback],workers = 4)

```

```
Train for 100 steps, validate for 20 steps
Epoch 1/10
100/100 [==============================] - 16s 156ms/step - loss: 0.4830 - accuracy: 0.7697 - val_loss: 0.3396 - val_accuracy: 0.8475
Epoch 2/10
100/100 [==============================] - 14s 142ms/step - loss: 0.3437 - accuracy: 0.8469 - val_loss: 0.2997 - val_accuracy: 0.8680
Epoch 3/10
100/100 [==============================] - 13s 131ms/step - loss: 0.2871 - accuracy: 0.8777 - val_loss: 0.2390 - val_accuracy: 0.9015
Epoch 4/10
100/100 [==============================] - 12s 117ms/step - loss: 0.2410 - accuracy: 0.9040 - val_loss: 0.2005 - val_accuracy: 0.9195
Epoch 5/10
100/100 [==============================] - 13s 130ms/step - loss: 0.1992 - accuracy: 0.9213 - val_loss: 0.1949 - val_accuracy: 0.9180
Epoch 6/10
100/100 [==============================] - 14s 136ms/step - loss: 0.1737 - accuracy: 0.9323 - val_loss: 0.1723 - val_accuracy: 0.9275
Epoch 7/10
100/100 [==============================] - 14s 139ms/step - loss: 0.1531 - accuracy: 0.9412 - val_loss: 0.1670 - val_accuracy: 0.9310
Epoch 8/10
100/100 [==============================] - 13s 134ms/step - loss: 0.1299 - accuracy: 0.9525 - val_loss: 0.1553 - val_accuracy: 0.9340
Epoch 9/10
100/100 [==============================] - 14s 137ms/step - loss: 0.1158 - accuracy: 0.9556 - val_loss: 0.1581 - val_accuracy: 0.9340
Epoch 10/10
100/100 [==============================] - 14s 142ms/step - loss: 0.1006 - accuracy: 0.9617 - val_loss: 0.1614 - val_accuracy: 0.9345
```

```python

```

### å››ï¼Œè¯„ä¼°æ¨¡å‹

```python
%load_ext tensorboard
#%tensorboard --logdir ./data/keras_model
```

```python
from tensorboard import notebook
notebook.list() 
```

```python
#åœ¨tensorboardä¸­æŸ¥çœ‹æ¨¡å‹
notebook.start("--logdir ./data/keras_model")
```

```python
# æ‰§è¡Œ"tensorboard --logdir=D:\tf_dir\tensorboard_study"
```

![](./data/1-2-tensorboard.jpg)

```python
import pandas as pd 
dfhistory = pd.DataFrame(history.history)
dfhistory.index = range(1,len(dfhistory) + 1)
dfhistory.index.name = 'epoch'

dfhistory
```

![](./data/1-2-dfhistory.jpg)

```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

import matplotlib.pyplot as plt

def plot_metric(history, metric):
    train_metrics = history.history[metric]
    val_metrics = history.history['val_'+metric]
    epochs = range(1, len(train_metrics) + 1)
    plt.plot(epochs, train_metrics, 'bo--')
    plt.plot(epochs, val_metrics, 'ro-')
    plt.title('Training and validation '+ metric)
    plt.xlabel("Epochs")
    plt.ylabel(metric)
    plt.legend(["train_"+metric, 'val_'+metric])
    plt.show()
```

```python
plot_metric(history,"loss")
```

![](./data/1-2-Lossæ›²çº¿.jpg)

```python
plot_metric(history,"accuracy")
```

![](./data/1-2-Accuracyæ›²çº¿.jpg)

```python
#å¯ä»¥ä½¿ç”¨evaluateå¯¹æ•°æ®è¿›è¡Œè¯„ä¼°
val_loss,val_accuracy = model.evaluate(ds_test,workers=4)
print(val_loss,val_accuracy)

```

```
0.16139143370091916 0.9345
```


### äº”ï¼Œä½¿ç”¨æ¨¡å‹


å¯ä»¥ä½¿ç”¨model.predict(ds_test)è¿›è¡Œé¢„æµ‹ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨model.predict_on_batch(x_test)å¯¹ä¸€ä¸ªæ‰¹é‡è¿›è¡Œé¢„æµ‹ã€‚

```python
model.predict(ds_test)
```

```
array([[9.9996173e-01],
       [9.5104784e-01],
       [2.8648047e-04],
       ...,
       [1.1484033e-03],
       [3.5589080e-02],
       [9.8537153e-01]], dtype=float32)
```

```python
for x,y in ds_test.take(1):
    print(model.predict_on_batch(x[0:20]))
```

```
tf.Tensor(
[[3.8065155e-05]
 [8.8236779e-01]
 [9.1433197e-01]
 [9.9921846e-01]
 [6.4052093e-01]
 [4.9970779e-03]
 [2.6735585e-04]
 [9.9842811e-01]
 [7.9198682e-01]
 [7.4823302e-01]
 [8.7208226e-03]
 [9.3951421e-03]
 [9.9790359e-01]
 [9.9998581e-01]
 [2.1642199e-05]
 [1.7915063e-02]
 [2.5839690e-02]
 [9.7538447e-01]
 [9.7393811e-01]
 [9.7333014e-01]], shape=(20, 1), dtype=float32)
```




```python
# # ğŸ›¬:0,ğŸš˜ï¼š1
import matplotlib.pyplot as plt

# a = tf.data.Dataset.list_files("./data/cifar2/test/*/*.jpg")  # é»˜è®¤éšæœºè¯»å–
a = tf.data.Dataset.list_files("./data/test/*.jpg")  # é»˜è®¤éšæœºè¯»å–

j= 0
for i in a:
    if j==30:break
    j += 1
    print(i)
    img = tf.io.read_file(i)
    img= tf.image.decode_jpeg(img)
    
    new_shape1 = 32
    img1 = tf.image.resize(img,[new_shape1, new_shape1])/255.0
    print(img1.shape)
    plt.imshow(img1)
    plt.show()
    predict_prob = model.predict(tf.expand_dims(img1, 0))  # æ‰©å……ç»´åº¦ï¼ˆbatch æ–¹å‘ï¼‰
    if predict_prob[0][0]>0.5:print('é¢„æµ‹ğŸš˜ğŸš˜ğŸš˜ğŸš˜ğŸš˜ğŸš˜ğŸš˜', predict_prob)
    else: print(f'é¢„æµ‹é£æœºğŸ›¬ğŸ›¬ğŸ›¬ğŸ›¬ğŸ›¬ğŸ›¬ğŸ›¬', 1-predict_prob)
    print('-'*40)

    
# def load_image(img_path,size = (32,32)):
#     label = tf.constant(1,tf.int8) if tf.strings.regex_full_match(img_path,".*automobile.*") \
#             else tf.constant(0,tf.int8)
#     img = tf.io.read_file(img_path)
#     img = tf.image.decode_jpeg(img) #æ³¨æ„æ­¤å¤„ä¸ºjpegæ ¼å¼
#     img = tf.image.resize(img,size)/255.0
#     return(img,label)
```

### å…­ï¼Œä¿å­˜æ¨¡å‹


æ¨èä½¿ç”¨TensorFlowåŸç”Ÿæ–¹å¼ä¿å­˜æ¨¡å‹ã€‚

```python
# ä¿å­˜æƒé‡ï¼Œè¯¥æ–¹å¼ä»…ä»…ä¿å­˜æƒé‡å¼ é‡
model.save_weights('./data/tf_model_weights.ckpt',save_format = "tf")
```

```python
# ä¿å­˜æ¨¡å‹ç»“æ„ä¸æ¨¡å‹å‚æ•°åˆ°æ–‡ä»¶,è¯¥æ–¹å¼ä¿å­˜çš„æ¨¡å‹å…·æœ‰è·¨å¹³å°æ€§ä¾¿äºéƒ¨ç½²

model.save('./data/tf_model_savedmodel', save_format="tf")
print('export saved model.')

model_loaded = tf.keras.models.load_model('./data/tf_model_savedmodel')
model_loaded.evaluate(ds_test)
```

```
[0.16139124035835267, 0.9345]
```

```python

```

å¦‚æœå¯¹æœ¬ä¹¦å†…å®¹ç†è§£ä¸Šæœ‰éœ€è¦è¿›ä¸€æ­¥å’Œä½œè€…äº¤æµçš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨å…¬ä¼—å·"ç®—æ³•ç¾é£Ÿå±‹"ä¸‹ç•™è¨€ã€‚ä½œè€…æ—¶é—´å’Œç²¾åŠ›æœ‰é™ï¼Œä¼šé…Œæƒ…äºˆä»¥å›å¤ã€‚

ä¹Ÿå¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤å…³é”®å­—ï¼š**åŠ ç¾¤**ï¼ŒåŠ å…¥è¯»è€…äº¤æµç¾¤å’Œå¤§å®¶è®¨è®ºã€‚

![ç®—æ³•ç¾é£Ÿå±‹äºŒç»´ç .jpg](./data/ç®—æ³•ç¾é£Ÿå±‹äºŒç»´ç .jpg)
